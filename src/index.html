<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>UDS Splitter</title>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <div id="page-container">
      <div id="content-wrap">
        <div class="title-container">
          <div class="logo">
            <img src="images/gsi_logo.png" class="logo">
          </div>
          <div class="title">
            <h1>
              UDS Splitter
            </h1>
          </div>
        </div>

        <div class="explanation">
          <p>
            This utility is designed to accept a UDS 2.0-compliant text file 
            and modify its size by splitting it into more consumable pieces 
            before importing into a Claim System
          </p>
        </div>

        <div class="form-container">
          <div class="file-select-container">
            <button id="choose-file">Choose a file</button>
            <span id="file-path"></span>
          </div>

         
          <div id="choose-zip-container" class="file-select-container" style="display:none">
            <button id="choose-zip-file">Choose the associated zip</button>
            <span id="zip-file-path"></span>
          </div>

          <div class="file-select-container">
            <button id="choose-output-directory">Choose the output directory</button>
            <span id="output-directory-path"></span>
          </div>

          <form id="submission-form">
            <div>   
              <label for="number-of-files">Number of Files:</label>
              <input type="text" id="number-of-files" name="number-of-files">
            </div>
            <div>
              <label for="open-folder">Open Folder on Complete:</label>
              <input type="checkbox" id="open-folder" name="open-folder">
            </div>
            <div class="submit-container">
              <button type="submit">Process File</button>
            </div>
          </form>
        </div>
      </div>

      <footer>
        This product is owned by Guaranty Support Inc. 
        For services please visit our website at <a href="guarantysupportinc.com">guarantysupportinc.com</a>. 
        For support questions, please contact support@guarantysupportinc.com.
      </footer>
    </div>

    <script>
      //form submission
      const form = document.getElementById('submission-form');
      let selectedFilePath = null;
      let selectedDirectoryPath = null;
      let selectedZipPath = null;
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => {
          data[key] = value;
        });

        if (selectedFilePath) {
          data.filePath = selectedFilePath;
        }

        //TODO:this is where output is determined... should default to folder path of input file if not selected
        // could get the inner.html instead of assigning the var in the separate event
        if (selectedDirectoryPath) {
          data.outputDir = selectedDirectoryPath;
        }
        else{
          data.outputDir = selectedFilePath.substring(0, selectedFilePath.lastIndexOf('/'));
        }

        if (selectedZipPath) {
          data.zipPath = selectedZipPath;
        }

        data['open-folder'] = formData.has('open-folder');  //will always put the value in the form and converts to boolean instead of 'on'

        //TODO might need to be moved up
        if (! selectedFilePath && ! data['number-of-files']) {
          alert('Please select a file to split and how many splits you wish to occur.');
        }
        else if (! selectedFilePath) {
          alert('Please select a file to split.');
        }
        else if (! data['number-of-files']) {
          alert('Please select how many splits you wish to occur.');
        }
        else{
          window.electron.send('submission-form', data);
          window.electron.receive('form-submitted', (message) => {
            console.log(message);
          });
        }
      });

      //file selection
      document.getElementById('choose-file').addEventListener('click', () => {
        window.electron.send('open-file-dialog');
      });

      window.electron.receive('selected-file', (filePath) => {
        if (filePath === 'canceled') {
          document.getElementById('file-path').innerText = 'No file selected';
          selectedFilePath = null;
          document.getElementById('choose-zip-container').style.display = 'none';
        } else {
          document.getElementById('file-path').innerText = filePath;
          selectedFilePath = filePath;
          const parts = filePath.split('/');
          const fileName = parts.pop();
          const recordType = fileName[5];
          if (recordType == 'I'){
            document.getElementById('choose-zip-container').style.display = 'block';
          }
          else{
            document.getElementById('choose-zip-container').style.display = 'none';
          }
        }
      });


      //output directory selection
      document.getElementById('choose-output-directory').addEventListener('click', () => {
        window.electron.send('open-directory-dialog');
      });
      window.electron.receive('selected-directory', (directoryPath) => {
        if (directoryPath === 'canceled') {
          document.getElementById('output-directory-path').innerText = 'No directory selected';
          selectedDirectoryPath = null;
        } else {
          document.getElementById('output-directory-path').innerText = directoryPath;
          selectedDirectoryPath = directoryPath;
        }
      });

      //zip file selection
      document.getElementById('choose-zip-file').addEventListener('click', () => {
        window.electron.send('open-zip-file-dialog');
      });
      window.electron.receive('selected-zip-file', (filePath) => {
        if (filePath === 'canceled') {
          document.getElementById('zip-file-path').innerText = 'No file selected';
          selectedZipPath = null;
        } else {
          document.getElementById('zip-file-path').innerText = filePath;
          selectedZipPath = filePath;
        }
      });

    </script>
  
  </body>
</html>
